<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Supabase お絵描きサイト（完全版）</title>
<style>
body { font-family: system-ui, -apple-system, "Helvetica Neue", Arial; max-width:1100px; margin:24px auto; padding:12px; }
header { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
#controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
canvas { border:1px solid #ccc; touch-action: none; background: white; display:block; margin-top:12px; }
.btn { padding:8px 10px; border-radius:6px; border:1px solid #888; background:#f6f6f6; cursor:pointer; }
.btn:active { transform: translateY(1px); }
#gallery { display:flex; gap:8px; flex-wrap:wrap; margin-top:18px; }
.thumb { width:150px; height:150px; object-fit:cover; border:1px solid #ddd; border-radius:6px; }
.sidebar { margin-left:auto; text-align:right; }
input[type="range"] { width:120px; }
label { font-size:14px; }
#status { margin-top:8px; color:#333; font-size:14px; }
footer { margin-top:18px; color:#666; font-size:13px; }
.small { font-size:13px; color:#555; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
<header>
<h1>お絵描きボード（Supabase 保存）</h1>
<div class="sidebar">
  <div id="userInfo" class="small">未ログイン</div>
  <div style="margin-top:6px;">
    <input id="emailInput" placeholder="メールでログイン" style="padding:6px;border:1px solid #ccc;border-radius:6px;">
    <button class="btn" id="loginBtn">Magic Link 送信</button>
    <button class="btn" id="logoutBtn" style="display:none">ログアウト</button>
  </div>
</div>
</header>

<div id="controls">
<label>色: <input type="color" id="color" value="#000000"></label>
<label>太さ: <input id="size" type="range" min="1" max="40" value="4"></label>
<button class="btn" id="eraserBtn">消しゴム</button>
<button class="btn" id="undoBtn">戻る</button>
<button class="btn" id="clearBtn">全消去</button>
<button class="btn" id="saveBtn">保存 (Supabase)</button>
<span id="status"></span>
</div>

<canvas id="board" width="800" height="600"></canvas>

<section>
<h2>ギャラリー</h2>
<div id="gallery"></div>
</section>

<footer>
<div class="small">使い方: 描いて → 保存 を押すと Supabase Storage に PNG を保存し、ギャラリーに追加されます。<br>
※ 初回はコード内の <code>supabaseUrl</code> と <code>supabaseKey</code> を自分の値に置き換えてください。</div>
</footer>

<script>
/* =======================
   Supabase 設定
   ======================= */
const supabaseUrl = "https://xiodxjoipeinrtoporbq.supabase.co";
const supabaseKey = "YOUR_ANON_KEY_HERE"; // 自分の anon/public API key
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

/* Canvas */
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
let drawing = false;
let last = { x:0, y:0 };
let tool = 'pen';
const colorInput = document.getElementById('color');
const sizeInput = document.getElementById('size');
const undoStack = [];
const MAX_UNDO = 20;

function pushUndo() { try { if (undoStack.length>=MAX_UNDO) undoStack.shift(); undoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height)); } catch(e){} }
function restoreUndo() { if(undoStack.length) ctx.putImageData(undoStack.pop(),0,0); }
function setStrokeStyle() { ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=parseInt(sizeInput.value,10); ctx.globalCompositeOperation=(tool==='eraser')?'destination-out':'source-over'; ctx.strokeStyle=colorInput.value; }
function getPosFromEvent(e) { const r=canvas.getBoundingClientRect(); if(e.touches&&e.touches[0]) return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top}; else return {x:e.offsetX,y:e.offsetY}; }
function pointerDown(e){ e.preventDefault(); drawing=true; last=getPosFromEvent(e); pushUndo(); setStrokeStyle(); }
function pointerMove(e){ if(!drawing) return; const p=getPosFromEvent(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }
function pointerUp(e){ drawing=false; }
canvas.addEventListener('pointerdown',pointerDown); canvas.addEventListener('pointermove',pointerMove);
canvas.addEventListener('pointerup',pointerUp); canvas.addEventListener('pointerleave',pointerUp);
canvas.addEventListener('touchstart',pointerDown); canvas.addEventListener('touchmove',pointerMove); canvas.addEventListener('touchend',pointerUp);
document.getElementById('eraserBtn').addEventListener('click',()=>{ tool=(tool==='eraser')?'pen':'eraser'; document.getElementById('eraserBtn').textContent=(tool==='eraser')?'消しゴム（ON）':'消しゴム'; setStrokeStyle(); });
document.getElementById('undoBtn').addEventListener('click',()=>restoreUndo());
document.getElementById('clearBtn').addEventListener('click',()=>{ pushUndo(); ctx.clearRect(0,0,canvas.width,canvas.height); });

/* Status */
const status = document.getElementById('status');
function setStatus(text, timeout=3000){ status.textContent=text; if(timeout) setTimeout(()=>{ if(status.textContent===text) status.textContent=''; },timeout); }

/* 白背景 */
ctx.save(); ctx.globalCompositeOperation='destination-over'; ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.restore();

/* =======================
   Supabase 保存・ギャラリー
   ======================= */
async function saveToSupabase(){
  setStatus('保存中…');
  try{
    const dataUrl=canvas.toDataURL('image/png');
    const blob=await(await fetch(dataUrl)).blob();
    const filename=`art-${Date.now()}.png`;
    const path=filename;

    const { data: uploadData, error: uploadErr } = await supabaseClient.storage.from('drawings').upload(path, blob, { cacheControl:'3600', upsert:false });
    if(uploadErr){ console.error(uploadErr); setStatus('アップロード失敗'); return; }

    const { data: publicData } = supabaseClient.storage.from('drawings').getPublicUrl(path);
    const publicUrl = publicData?.publicUrl ?? null;

    const { data: { user } } = await supabaseClient.auth.getUser();
    const { error: insertErr } = await supabaseClient.from('gallery').insert([{ url:publicUrl, filename, user_id:user?user.id:null }]);
    if(insertErr){ console.error(insertErr); setStatus('ギャラリー登録エラー'); return; }

    setStatus('保存完了！'); loadGallery();
  }catch(e){ console.error(e); setStatus('エラー発生'); }
}
document.getElementById('saveBtn').addEventListener('click', saveToSupabase);

async function loadGallery(){
  const { data, error } = await supabaseClient.from('gallery').select('*').order('created_at',{ascending:false}).limit(40);
  const g=document.getElementById('gallery'); g.innerHTML='';
  if(error){ console.error(error); return; }
  data.forEach(item=>{ const img=document.createElement('img'); img.className='thumb'; img.src=item.url; img.alt=item.filename||'drawing'; g.appendChild(img); });
}
loadGallery();

/* =======================
   Magic Link 認証
   ======================= */
const emailInput = document.getElementById('emailInput');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userInfo = document.getElementById('userInfo');

async function updateUserUI(){
  const { data:{user} } = await supabaseClient.auth.getUser().catch(()=>({data:{user:null}}));
  if(user){ userInfo.textContent=`ログイン済み: ${user.email}`; loginBtn.style.display='none'; emailInput.style.display='none'; logoutBtn.style.display=''; }
  else{ userInfo.textContent='未ログイン'; loginBtn.style.display=''; emailInput.style.display=''; logoutBtn.style.display='none'; }
}

// Magic Link ログイン（リダイレクト先を GitHub Pages に）
loginBtn.addEventListener('click', async ()=>{
  const email=emailInput.value.trim();
  if(!email) return setStatus('メールを入力してね');
  setStatus('ログインリンク送信中…');
  const { error } = await supabaseClient.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo: "https://git0104.github.io/oekaki/supabase" }
  });
  if(error){ console.error(error); setStatus('送信エラー'); } else { setStatus('メールを送信したよ（受信箱を確認）',5000); }
});

// ログアウト
logoutBtn.addEventListener('click', async ()=>{ await supabaseClient.auth.signOut(); updateUserUI(); setStatus('ログアウトしました'); });

// 認証状態変化監視
supabaseClient.auth.onAuthStateChange(()=>{ updateUserUI(); });

// 初期 UI
updateUserUI();
</script>
</body>
</html>


